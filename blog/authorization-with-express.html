<!DOCTYPE html>
<html>
<head>
<title>RallyCoding: Authorization with Express</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="../assets/css/index.css">

</head>
<body class="">
  <!-- navbar -->
  <nav class="navbar navbar-expand-lg navbar-light p-5">
    <div class="container">
      <a class="navbar-brand text-white" href="/"><h3>Devbootstrap</h3></a>
      <button class="navbar-toggler bg-white" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto ">
          <li class="nav-item ">
            <a class="nav-link text-white text-white" href="/courses"><h6>Courses</h6></a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white  " href="/blog"><h6>Blog</h6></a>
          </li>
          <li class="nav-item">
            <a class="nav-link  text-white" href="/videos" tabindex="-1" aria-disabled="true"><h6>Video</h6></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h2>Authorization with Express</h2>
    <p>A student asked:</p>
    <blockquote>
        <p>I am starting a new project using what I have learnt and I was wondering: what do you use in your projects to handle roles and permissions? Custom code? existing packages? I assume it has to be server side logic.
          Any suggestion is more than welcomed.
          Thanks again for the courses, I hope there is more to come!</p>
      </blockquote>
      <h3>Authentication vs. Authorization</h3>

      <p>First, it is important to note the difference between authentication and authorization. Authentication is used to establish and confirm the identity of a user. Authorization determines what an authenticated user has access to. It is easy to spot apps with authentication; generally, all you need to look for is a place to login or register. However, authorization comes in many forms, from only being able to delete your own comments, to seeing a different set of options in a navigation tab, to being able to view app analytics. The most common instance of authorization that you might see is the existence of &quot;admin&quot; priviliges in an app.</p>

      <p>Authentication is a fairly standardized process. Using a Node backend, you will find that the <a href="http://passportjs.org/">Passport</a> and <a href="https://www.npmjs.com/package/bcrypt">Bcrypt</a> libraries are popular choices for implemention. Unfortunately, finding libraries for authorization is more difficult because of how customized roles and permissions are. They need to be designed on a case by case basis to match the requirements of the app being built.</p>

      <h3>The Server is the Gatekeeper</h3>

      <p>Ultimately, secure and effective authentication and authorization systems <strong><em>MUST</em></strong> be implemented on the backend. As mentioned many times in the <a href="https://www.rallycoding.com/courses/advanced-react-and-redux/">Advanced React Course</a>, security has to be implemented by the server side, not by the client - you must always assume that users are able to circumvent any client-side security you set up.</p>

      <p>Now, of course, you can have checks on the client side. It will provide faster performance for the user. But client-side checks can always be bypassed, so the server must act as the gatekeeper.</p>

      <p>That being said, how can you start implementing an system of authorization?</p>

      <h3>Middleware to the Rescue</h3>

      <p>Express provides a lot of flexibility when handling requests. Often, handling requests looks like this:</p>

      <pre><code class="">app.get(&#39;/&#39;, (req, res) =&gt; {//do something and send a response});</code></pre>

      <p>The flexibility lies in the fact that a sequence of functions can be added to the request handler:</p>
      <pre class="bg-secondary">
        <code class="">app.get(&#39;/&#39;, doSomething, (req, res) =&gt; {//do something and send a response});
        const doSomething = (req, res, next) =&gt; {
          // do something with the request
          // then move to the next function
          next();
          // calling next is the only way move
          // to the next function
        };
        </code>
      </pre>
      <p>The function <code>doSomething</code> is called middleware. In general, it is useful when reusable logic is needed to run before the final route handler. Middleware is the perfect tool for adding authorization logic. You can even have multiple middlewares run, in order.</p>
      <pre class="bg-secondary">
        <code class="">// 3 middlewares that will run in order
          app.get(&#39;/&#39;,
            doSomething,
            doThisNext,
            andThenThis,
            (req, res) =&gt; {
            //do something and send a response
          });
        </code>
      </pre>
      <p>In the case above, the functions will run, in order, one after the other. Each middleware is passed the <code>req</code>, <code>res</code>, and <code>next</code> parameters. Most importantly, <code>next()</code> must be called at some point in each function so that Express knows to move to the next function.</p>

      <h3>Implementing Middleware</h3>

      <p>Using middleware, I would likely write a function to verify the user&#39;s role, then secure each route in the app with the appropriate middleware.</p>

      <p>For example, I might have a <code>requireAdmin</code> middleware, that looks something like this:</p>

      <pre class="bg-secondary">
        <code class="">const requireAdmin = (req, res, next) =&gt;
          {
            if (!req.user.isAdmin) {
              return res.status(401).send({ error: &#39;You are not authorized&#39; });
            }
            next();
          }
        </code>
      </pre>
      <p>Or a middleware to assert that a resource (like a blog post) that a user is trying to edit belongs to them:</p>
      <pre class="bg-secondary">
        <code class="">// Node 7.6+ is required to use async/await
          const requireUserIsPostOwner = async (req, res, next) =&gt; {
            let post = await Post.find(req.params.id);

            if (req.user.id !== post.ownerId) {
              return res.status(401).send({ error: &#39;You do not own this post.&#39; });
            }
            next();
          }
        </code>
      </pre>
      <p>Then you could mix and match these middlewares. If you had a route that allows a user to delete a post only if they are an admin and the owner of the post, you could do:</p>
      <pre class="bg-secondary">
        <code class="">app.delete(&#39;/posts/:id&#39;, requireAdmin, requireUserIsPostOwner, (req, res) =&gt; {
          // logic to delete post
        });
        </code>
      </pre>
      <p>The beauty of this approach is that each middleware is easily testable and can easily be composed into dramatically more complicated authorization structures. In addition, the reusability of middleware cut down on redundant code and makes it even more powerful:</p>
      <pre class="bg-secondary">
        <code class="">app.use(&#39;/posts&#39;, requireAdmin, requireUserIsPostOwner, handleRoute);
          // Every request to posts, including nested routes, will run the
          // requireAuth and requireUserIsPostOwner middleware.
        </code>
      </pre>
      <p>As you can see, Express middleware is an excellent option for handling authorization. It will significantly reduce the amount of code required in your route handlers, while making the development and maintenance of your application simpler.</p>
      <a class = "btn bg-primary" href="/blog/coding-challenge-asyncawait-and-react.html" class="ui labeled left floated icon button">
        Previous Post
      </a>
      <a class = "btn bg-primary" href="/blog/mlab-development-with-a-database-as-a-service.html" class="ui right labeled right floated icon button">
        Next Post
      </a>

  </div>
  <br><br>
  <!-- footer -->
    <nav class="navbar navbar-expand-lg navbar-light p-4">
      <div class="container mt-1">
        <p class="text-white mt-1">Rotati@2019 devbootstrap</p>
        <div class="collapse navbar-collapse" id=""></div>
          <ul class="navbar-nav ml-auto ">
            <li class="nav-item ">
              <a class="nav-link text-white text-white" href="/courses">Courses</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white  " href="/blog">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link  text-white" href="/videos" tabindex="-1" aria-disabled="true">Video</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>